!function(t,e){"object"==typeof exports&&"object"==typeof module?module.exports=e():"function"==typeof define&&define.amd?define([],e):"object"==typeof exports?exports.dogdog=e():t.dogdog=e()}(self,(()=>(()=>{"use strict";var t={d:(e,n)=>{for(var o in n)t.o(n,o)&&!t.o(e,o)&&Object.defineProperty(e,o,{enumerable:!0,get:n[o]})},o:(t,e)=>Object.prototype.hasOwnProperty.call(t,e),r:t=>{"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(t,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(t,"__esModule",{value:!0})}},e={};t.r(e),t.d(e,{initEngine:()=>W});const n=(t,e,n)=>{t.setAttribute("width",e+""),t.setAttribute("height",n+"")},o=t=>Object.assign(Object.create(null),t),r=new Map,i=(new Map,new Map),a=()=>({set:(t,e)=>{if("number"!=typeof t)return;const n=i.get(t);n?n.push(...e):i.set(t,[...e])},get:t=>i.get(t),delete:t=>i.delete(t),getAll:()=>{const t=[];for(const e of i)t.push(e);return t},clear:()=>{i.clear()}}),s=t=>{t=t||32;let e="";for(let n=0;n<t;n++)e+="ABCDEFGHJKMNPQRSTWXYZabcdefhijkmnprstwxyz2345678".charAt(Math.floor(48*Math.random()));return e},l=t=>180*t/Math.PI,d=(t,e,n)=>{const{minX:o,maxX:r,minY:i,maxY:a}=t,s="toLeft"===e||"toRight"===e,l="toLeft"===e||"toBottom"===e,d=s?i:o,c=s?a:r;let h=t[{toLeft:"maxX",toRight:"minX",toTop:"minY",toBottom:"maxY"}[e]],m=s?r-o:a-i,x=!1;for(;m&&!x;){for(let t=d;t<c&&(x=s?n.isPointInStroke(h,t):n.isPointInStroke(t,h),!x);t++);if(x)break;m--,l?h--:h++}return h},c=(t,e,n)=>{const o=e.map((t=>t.x)),r=e.map((t=>t.y)),i=[...t.map((t=>t.x)),...o].filter((t=>!!t)),a=[...t.map((t=>t.y)),...r].filter((t=>!!t));let[s,l,c,h]=[Math.min(...i),Math.max(...i),Math.min(...a),Math.max(...a)];return o.includes(l)&&(l=d({minX:s,minY:c,maxX:l,maxY:h},"toLeft",n)),o.includes(s)&&(s=d({minX:s,minY:c,maxX:l,maxY:h},"toRight",n)),r.includes(h)&&(h=d({minX:s,minY:c,maxX:l,maxY:h},"toTop",n)),r.includes(c)&&(c=d({minX:s,minY:c,maxX:l,maxY:h},"toBottom",n)),{minX:s,minY:c,maxX:l,maxY:h}},h=t=>{const e=t>=0?t%360:360+t%360;return 4-Math.floor(e/90)},m=t=>{const e=t>=0?t%360:360+t%360,n=4-Math.floor(e/90);let o;return 1===n?o=360-e:2===n?o=e-180:3===n?o=180-e:4===n&&(o=e),o},x=t=>{const e=t.arc;return(n,o,r,i,s,d)=>{const{drawCoordinates:c,drawOffset:{dx:x,dy:u}}=t;if(e.call(t,n+x,o+u,r,i,s,d),!c)return;const{set:f}=a();let g;(s-i)%360!=0?g=((t,e,n,o,r)=>{let i,a,s,l;const[d,c]=[h(o),h(r)],[x,u]=[m(o),m(r)],f=n*Math.cos(x*Math.PI/180),g=n*Math.cos(u*Math.PI/180),p=n*Math.sin(x*Math.PI/180),y=n*Math.sin(u*Math.PI/180);return 1===d?2===c?(i=t-n,a=t+n,s=e-Math.max(p,y),l=e+n):3===c?(i=t-g,a=t+n,s=e-p,l=e+n):4===c?(i=t+Math.min(f,g),a=t+n,s=e-p,l=e+y):x>u?(i=t+f,a=t+g,s=e-p,l=e-y):(i=t-n,a=t+n,s=e-n,l=e+n):2===d?1===c?(i=t-f,a=t+g,s=e-n,l=e-Math.min(p,y)):3===c?(i=t-Math.max(f,g),a=t+n,l=e+n,s=e-n):4===c?(i=t-f,a=t+n,s=e-n,l=e+y):u>x?(i=t-f,a=t-g,l=e-y,s=e-p):(i=t-n,a=t+n,s=e-n,l=e+n):3===d?1===c?(i=t-n,a=t+g,s=e-n,l=e+p):2===c?(i=t-n,a=t-Math.min(f,g),s=e-y,l=e+p):4===c?(i=t-n,a=t+n,s=e-Math.max(p,y),l=e+n):x>u?(i=t-g,a=t-f,s=e+y,l=e+p):(i=t-n,a=t+n,s=e-n,l=e+n):1===c?(i=t-n,a=t+Math.max(f,g),s=e-n,l=e+n):2===c?(i=t-n,a=t+f,s=e-y,l=e+n):3===c?(i=t-g,a=t+f,s=e+Math.min(p,y),l=e+n):u>x?(i=t+g,a=t+f,s=e+p,l=e+y):(i=t-n,a=t+n,s=e-n,l=e+n),{minX:i,maxX:a,minY:s,maxY:l}})(n,o,r,l(i),l(s)):s>i&&(g={minX:n-r,maxX:n+r,minY:o-r,maxY:o+r});const p=[{x:g.minX,y:g.minY},{x:g.maxX,y:g.maxY}];f(t.lineWidth,p),c.push(...p),t.$arc=e}},u=t=>{const e=t.arcTo;return t.$arcTo=e,(n,o,r,i,s)=>{const{set:l}=a(),{drawCoordinates:d,drawOffset:{dx:h,dy:m}}=t;if(e.call(t,n+h,o+m,r+h,i+m,s),!d)return;const x=d.at(-1);let u={x:n,y:o},f={x:r,y:i};if(x){const{minX:e,minY:a,maxX:s,maxY:l}=c([{x:x.x,y:x.y},{x:r,y:i}],[{x:n,y:o}],t);u={x:e,y:a},f={x:s,y:l}}const g=[u,f];d.push(...g),l(t.lineWidth,g)}},f=t=>{const e=t.rect;return t.$rect=e,(n,o,r,i)=>{const{set:s}=a(),{drawCoordinates:l,drawOffset:{dx:d,dy:c}}=t;if(e.call(t,n+d,o+c,r,i),!l)return;const h={minX:n,minY:o,maxX:n+r,maxY:o+i},m=[{x:h.minX,y:h.minY},{x:h.maxX,y:h.maxY}];l.push(...m),s(t.lineWidth,m)}},g=t=>{const e=t.fillRect;return t.$fillRect=e,(n,o,r,i)=>{const{drawCoordinates:a,drawOffset:{dx:s,dy:l}}=t;if(e.call(t,n+s,o+l,r,i),!a)return;const d={minX:n,minY:o,maxX:n+r,maxY:o+i};a.push({x:d.minX,y:d.minY},{x:d.maxX,y:d.maxY})}},p=t=>{const e=t.strokeRect;return t.$strokeRect=e,(n,o,r,i)=>{const{set:s}=a(),{drawCoordinates:l,drawOffset:{dx:d,dy:c}}=t;if(e.call(t,n+d,o+c,r,i),!l)return;const h={minX:n,minY:o,maxX:n+r,maxY:o+i},m=[{x:h.minX,y:h.minY},{x:h.maxX,y:h.maxY}];l.push(...m),s(t.lineWidth,m)}},y=t=>{const e=t.lineTo;return t.$lineTo=e,(n,o)=>{const{drawCoordinates:r,drawOffset:{dx:i,dy:s}}=t;if(e.call(t,n+i,o+s),!r)return;const{set:l}=a(),d={x:n,y:o};r.push(d),l(t.lineWidth,[d])}},w=t=>{const e=t.moveTo;return t.$moveTo=e,(n,o)=>{const{set:r}=a(),i={x:n,y:o},{drawCoordinates:s,drawOffset:{dx:l,dy:d}}=t;e.call(t,n+l,o+d),s&&(s.push(i),r(t.lineWidth,[i]))}},b=t=>{const e=t.bezierCurveTo;return t.$bezierCurveTo=e,(n,o,r,i,s,l)=>{const{set:d}=a(),{drawCoordinates:h,drawOffset:{dx:m,dy:x}}=t;if(e.call(t,n+m,o+x,r+m,i+x,s+m,l+x),!h)return;const u=h.at(-1);if(u){const{minX:e,minY:a,maxX:m,maxY:x}=c([{x:u.x,y:u.y},{x:s,y:l}],[{x:n,y:o},{x:r,y:i}],t),f=[{x:e,y:a},{x:m,y:x}];h.push(...f),d(t.lineWidth,f)}else{const e=[{x:n,y:o},{x:r,y:i},{x:s,y:l}];h.push(...e),d(t.lineWidth,e)}}},v=t=>{const e=t.quadraticCurveTo;return t.$quadraticCurveTo=e,(n,o,r,i)=>{const{set:s}=a(),{drawCoordinates:l,drawOffset:{dx:d,dy:h}}=t;if(e.call(t,n+d,o+h,r+d,i+h),!l)return;const m=l.at(-1);let x={x:n,y:o},u={x:r,y:i};if(m){const{minX:e,minY:a,maxX:s,maxY:l}=c([{x:r,y:i},{x:m.x,y:m.y}],[{x:n,y:o}],t);x={x:e,y:a},u={x:s,y:l}}const f=[x,u];l.push(...f),s(t.lineWidth,f)}},X=t=>{const e=t.stroke;return t.$stroke=e,(...n)=>{const{drawCoordinates:o,drawOffset:{dx:r,dy:i}}=t;if(e.apply(t,n),!o)return;const{getAll:s,clear:l}=a(),d=t.lineWidth;if(1!==d){const t=s();for(const e of t){const t=e[1],n=Math.ceil((d-1)/2);for(const e of t)e.dWidth=n}}l()}},Y=()=>({arc:x,arcTo:u,rect:f,fillRect:g,strokeRect:p,moveTo:w,lineTo:y,bezierCurveTo:b,quadraticCurveTo:v,stroke:X}),M=(t,e)=>{const{arc:n,arcTo:o,rect:r,fillRect:i,strokeRect:a,moveTo:s,lineTo:l,stroke:d}=Y();t.arc=n(t),t.arcTo=o(t),t.rect=r(t),t.fillRect=i(t),t.strokeRect=a(t),t.moveTo=s(t),t.lineTo=l(t),t.quadraticCurveTo=v(t),t.bezierCurveTo=b(t),t.stroke=d(t)},O=t=>{var e,n,r,i;const a=o({minX:999999,maxX:-999999,minY:999999,maxY:-999999}),s=new Map;for(const e of t){const{x:t,y:n,dWidth:o}=e;a.minX>t&&(a.minX=t,s.set("minX",null!=o?o:0)),a.maxX<t&&(a.maxX=t,s.set("maxX",null!=o?o:0)),a.minY>n&&(a.minY=n,s.set("minY",null!=o?o:0)),a.maxY<n&&(a.maxY=n,s.set("maxY",null!=o?o:0))}const l={minX:a.minX-(null!==(e=s.get("minX"))&&void 0!==e?e:0),maxX:a.maxX+(null!==(n=s.get("maxX"))&&void 0!==n?n:0),minY:a.minY-(null!==(r=s.get("minY"))&&void 0!==r?r:0),maxY:a.maxY+(null!==(i=s.get("maxY"))&&void 0!==i?i:0)};return{ox:l.minX,oy:l.minY,width:l.maxX-l.minX,height:l.maxY-l.minY}},C=(t,e)=>{const{ox:n,oy:o,width:r,height:i}=e,a=n+r+4,s=o+i+4,l=new OffscreenCanvas(a,s).getContext("2d");t(l);const d=null==l?void 0:l.getImageData(0,0,a,s),c=null==d?void 0:d.data;let[h,m,x,u]=[n,o,n+r,o+i],f=!1;for(let t=m;t<s;t++){for(let e=h;e<a;e++){const n=4*(t*a+e),o=c[n],r=c[n+1],i=c[n+2],s=c[n+3];if(0!=o||0!=r||0!=i||0!=s){f=!0,m=t;break}}if(f)break}let g=!1;for(let t=o+i;t>o;t--){for(let e=n-4;e<a;e++){const n=4*(t*a+e),o=c[n],r=c[n+1],i=c[n+2],s=c[n+3];if(0!=o||0!=r||0!=i||0!=s){u=t,g=!0;break}}if(g)break}let p=!1;for(let t=n;t<a;t++){for(let e=o-4;e<s;e++){const n=4*(e*a+t),o=c[n],r=c[n+1],i=c[n+2],s=c[n+3];if(0!=o||0!=r||0!=i||0!=s){p=!0,h=t;break}}if(p)break}let y=!1;for(let t=n+r;t>t;t--){for(let e=o-4;e<s;e++){const n=4*(e*a+t),o=c[n],r=c[n+1],i=c[n+2],s=c[n+3];if(0!=o||0!=r||0!=i||0!=s){x=t,y=!0;break}}if(y)break}return{ox:h,oy:m,width:x-h,height:u-m}},T=new Map,$=t=>{const e=t+":";return{addModel:n=>{const o=(i=n,Array.isArray(i)?n:[n]);var i;const{width:a,height:s}=R.get(t).engine,l=((t,e)=>{const n=`${t}_${e}`;return r.get(n)||r.set(n,new OffscreenCanvas(t,e)).get(n)})(a,s),d=l.getContext("2d");M(d);for(const t of o){const{draw:n}=t;Object.defineProperty(t,"__draw__",{writable:!1,value:n}),t.draw=(()=>{let e=!1;return(o,r)=>{const i={dx:r&&t.graphics?r.x-t.graphics.ox:0,dy:r&&t.graphics?r.y-t.graphics.oy:0};if(o.drawOffset=i,e)n(o);else{const r=[];o.drawCoordinates=r,n(o);const i=C(n,O(r));t.graphics=Object.assign({},i),e=!0,o.drawCoordinates=null}}})(),T.set(`${e}${t.name}`,t),null==d||d.clearRect(0,0,a,s),t.draw(d)}},getModel:t=>T.get(`${e}${t}`),deleteModel:t=>T.delete(`${e}${t}`)}};class S{constructor(t,e,n,r,i){var a,l,d,c;this.index=0,this.data=void 0,this.children=[],this.borderOptions={paddingLeft:10,paddingRight:10,paddingTop:4,paddingBottom:4,borderDash:[5,5],borderWidth:1,borderColor:"teal",radius:0};const{getModel:h}=$(e);this.$model=h(t),this.borderOptions=Object.assign(Object.assign({},this.borderOptions),null!==(l=null===(a=this.$model)||void 0===a?void 0:a.borderOptions)&&void 0!==l?l:{}),this.data=n,this.id=s(8),this.index=null!=i?i:this.index,this.belongEngineId=e,this._graphics=o(null===(d=this.$model)||void 0===d?void 0:d.graphics),this.graphics=o(null===(c=this.$model)||void 0===c?void 0:c.graphics),this.$model}draw(t,e,n={x:this.graphics.ox,y:this.graphics.oy}){var o,r;return this.ctx=t,null===(r=null===(o=this.$model)||void 0===o?void 0:o.draw)||void 0===r||r.call(o,t,n),this.graphics=Object.assign(Object.assign({},this.graphics),{ox:n.x,oy:n.y}),this.drawBoundary(),this.id}drawBoundary(){const{paddingLeft:t,paddingRight:e,paddingTop:n,paddingBottom:o,borderDash:r,borderWidth:i,borderColor:a}=this.borderOptions,s=null!=a?a:"#993f55",l=null!=i?i:2,d=null!=r?r:[9,2];this.ctx.save(),this.ctx.beginPath(),this.ctx.strokeStyle=s,this.ctx.lineWidth=l,this.ctx.setLineDash(d),this.ctx.$strokeRect(this.graphics.ox-(null!=t?t:4),this.graphics.oy-(null!=n?n:4),this.graphics.width+(null!=t?t:4)+(null!=e?e:4),this.graphics.height+(null!=n?n:4)+(null!=o?o:4)),this.ctx.setLineDash([0,0]),this.ctx.restore()}isPointInTheShape(t){}move(t,e){}}const k=new Map,j=Object.freeze({error:Symbol("__isError__"),engine:Symbol("__isEngine__"),shape:Symbol("__isShape"),model:Symbol("__isModel__")}),_=(t,e)=>{Object.defineProperty(t,j[e].description,{value:j[e],writable:!1})},P=t=>{const e=Object.create(null);return e.msg=t,_(e,"error"),e},R=new Map,W=t=>{const{id:e,width:r,height:i,canvas:a,modelList:l,readonly:d}=t,c=R.get(null!=e?e:"");if(c)return c;const h=a instanceof HTMLCanvasElement?a:"string"===(t=>Object.prototype.toString.call(t).slice(8,-1).toLowerCase())(a)&&document.querySelector(`#${a}`);if(!(h instanceof HTMLCanvasElement))throw P(`Create engine instance error: can't find a canvas dom by id ${a}`);const m=(p="2d",h.getContext(p,Object.assign(Object.assign({},{alpha:!0,antialias:!0,depth:!0,failIfMajorPerformanceCaveat:Boolean,powerPreference:"default",premultipliedAlpha:!1,preserveDrawingBuffer:!1,stencil:!0}),y))),x=null!=e?e:s(8),u=null!=d&&d,f=null!=r?r:300,g=null!=i?i:300;var p,y;M(m),n(h,f,g);const w=o({ctx:m,id:x,width:f,height:g,readonly:u,canvas:h}),{addModel:b,getModel:v,deleteModel:X}=$(x),{drawShape:Y,getShape:O,createShape:C}=((t,e)=>({createShape:(t,n,o,r)=>new S(t,e,n,o,r),drawShape:(n,o)=>{try{const r=n.draw(t,e,o);return k.set(r,n),r}catch(t){console.warn("create Shape error: unknown error")}},getShape:t=>k.get(t)}))(m,x),T=o({engine:w,addModel:t=>b(t),getModel:t=>v(t),deleteModel:t=>X(t),drawShape:(t,e)=>{var n;try{return Y(t,e)}catch(e){throw P(`Draw shape ${null===(n=t.$model)||void 0===n?void 0:n.name} course an error`)}},getShape:t=>O(t),createShape:(t,e)=>C(t,null==e?void 0:e.data,null==e?void 0:e.model,null==e?void 0:e.index),resizeCanvas:(t,e)=>{const{ctx:o,width:r,height:i,canvas:a}=w,s=o.getImageData(0,0,r,i);n(a,t,e),Object.assign(w,{width:t,height:e}),o.putImageData(s,0,0)}});return _(T,"engine"),R.set(T.engine.id,T),b(null!=l?l:[]),T};return e})()));