!function(t,e){"object"==typeof exports&&"object"==typeof module?module.exports=e():"function"==typeof define&&define.amd?define([],e):"object"==typeof exports?exports.dogdog=e():t.dogdog=e()}(self,(()=>(()=>{"use strict";var t={d:(e,n)=>{for(var i in n)t.o(n,i)&&!t.o(e,i)&&Object.defineProperty(e,i,{enumerable:!0,get:n[i]})},o:(t,e)=>Object.prototype.hasOwnProperty.call(t,e),r:t=>{"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(t,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(t,"__esModule",{value:!0})}},e={};t.r(e),t.d(e,{initEngine:()=>B});const n=(t,e,n)=>{t.setAttribute("width",e+""),t.setAttribute("height",n+"")},i=t=>Object.assign(Object.create(null),t),o=(t,e)=>{let n=t;return t%e!=0&&n++,n},r=new Map,a=(new Map,new Map),s=()=>({set:(t,e)=>{if("number"!=typeof t)return;const n=a.get(t);n?n.push(...e):a.set(t,[...e])},get:t=>a.get(t),delete:t=>a.delete(t),getAll:()=>{const t=[];for(const e of a)t.push(e);return t},clear:()=>{a.clear()}}),l=t=>{t=t||32;let e="";for(let n=0;n<t;n++)e+="ABCDEFGHJKMNPQRSTWXYZabcdefhijkmnprstwxyz2345678".charAt(Math.floor(48*Math.random()));return e},d=t=>180*t/Math.PI,c=(t,e,n)=>{const{minX:i,maxX:o,minY:r,maxY:a}=t,s="toLeft"===e||"toRight"===e,l="toLeft"===e||"toBottom"===e,d=s?r:i,c=s?a:o;let h=t[{toLeft:"maxX",toRight:"minX",toTop:"minY",toBottom:"maxY"}[e]],m=s?o-i:a-r,u=!1;for(;m&&!u;){for(let t=d;t<c&&(u=s?n.isPointInStroke(h,t):n.isPointInStroke(t,h),!u);t++);if(u)break;m--,l?h--:h++}return h},h=(t,e,n)=>{const i=e.map((t=>t.x)),o=e.map((t=>t.y)),r=[...t.map((t=>t.x)),...i].filter((t=>!!t)),a=[...t.map((t=>t.y)),...o].filter((t=>!!t));let[s,l,d,h]=[Math.min(...r),Math.max(...r),Math.min(...a),Math.max(...a)];return i.includes(l)&&(l=c({minX:s,minY:d,maxX:l,maxY:h},"toLeft",n)),i.includes(s)&&(s=c({minX:s,minY:d,maxX:l,maxY:h},"toRight",n)),o.includes(h)&&(h=c({minX:s,minY:d,maxX:l,maxY:h},"toTop",n)),o.includes(d)&&(d=c({minX:s,minY:d,maxX:l,maxY:h},"toBottom",n)),{minX:s,minY:d,maxX:l,maxY:h}},m=t=>{const e=t>=0?t%360:360+t%360;return 4-Math.floor(e/90)},u=t=>{const e=t>=0?t%360:360+t%360,n=4-Math.floor(e/90);let i;return 1===n?i=360-e:2===n?i=e-180:3===n?i=180-e:4===n&&(i=e),i},x=t=>{const e=t.arc;return(n,i,o,r,a,l)=>{const{drawCoordinates:c,drawOffset:{dx:h,dy:x}}=t;if(e.call(t,n+h,i+x,o,r,a,l),!c)return;const{set:f}=s();let g;(a-r)%360!=0?g=((t,e,n,i,o)=>{let r,a,s,l;const[d,c]=[m(i),m(o)],[h,x]=[u(i),u(o)],f=n*Math.cos(h*Math.PI/180),g=n*Math.cos(x*Math.PI/180),p=n*Math.sin(h*Math.PI/180),y=n*Math.sin(x*Math.PI/180);return 1===d?2===c?(r=t-n,a=t+n,s=e-Math.max(p,y),l=e+n):3===c?(r=t-g,a=t+n,s=e-p,l=e+n):4===c?(r=t+Math.min(f,g),a=t+n,s=e-p,l=e+y):h>x?(r=t+f,a=t+g,s=e-p,l=e-y):(r=t-n,a=t+n,s=e-n,l=e+n):2===d?1===c?(r=t-f,a=t+g,s=e-n,l=e-Math.min(p,y)):3===c?(r=t-Math.max(f,g),a=t+n,l=e+n,s=e-n):4===c?(r=t-f,a=t+n,s=e-n,l=e+y):x>h?(r=t-f,a=t-g,l=e-y,s=e-p):(r=t-n,a=t+n,s=e-n,l=e+n):3===d?1===c?(r=t-n,a=t+g,s=e-n,l=e+p):2===c?(r=t-n,a=t-Math.min(f,g),s=e-y,l=e+p):4===c?(r=t-n,a=t+n,s=e-Math.max(p,y),l=e+n):h>x?(r=t-g,a=t-f,s=e+y,l=e+p):(r=t-n,a=t+n,s=e-n,l=e+n):1===c?(r=t-n,a=t+Math.max(f,g),s=e-n,l=e+n):2===c?(r=t-n,a=t+f,s=e-y,l=e+n):3===c?(r=t-g,a=t+f,s=e+Math.min(p,y),l=e+n):x>h?(r=t+g,a=t+f,s=e+p,l=e+y):(r=t-n,a=t+n,s=e-n,l=e+n),{minX:r,maxX:a,minY:s,maxY:l}})(n,i,o,d(r),d(a)):a>r&&(g={minX:n-o,maxX:n+o,minY:i-o,maxY:i+o});const p=[{x:g.minX,y:g.minY},{x:g.maxX,y:g.maxY}];f(t.lineWidth,p),c.push(...p),t.$arc=e}},f=t=>{const e=t.arcTo;return t.$arcTo=e,(n,i,o,r,a)=>{const{set:l}=s(),{drawCoordinates:d,drawOffset:{dx:c,dy:m}}=t;if(e.call(t,n+c,i+m,o+c,r+m,a),!d)return;const u=d.at(-1);let x={x:n,y:i},f={x:o,y:r};if(u){const{minX:e,minY:a,maxX:s,maxY:l}=h([{x:u.x,y:u.y},{x:o,y:r}],[{x:n,y:i}],t);x={x:e,y:a},f={x:s,y:l}}const g=[x,f];d.push(...g),l(t.lineWidth,g)}},g=t=>{const e=t.rect;return t.$rect=e,(n,i,o,r)=>{const{set:a}=s(),{drawCoordinates:l,drawOffset:{dx:d,dy:c}}=t;if(e.call(t,n+d,i+c,o,r),!l)return;const h={minX:n,minY:i,maxX:n+o,maxY:i+r},m=[{x:h.minX,y:h.minY},{x:h.maxX,y:h.maxY}];l.push(...m),a(t.lineWidth,m)}},p=t=>{const e=t.fillRect;return t.$fillRect=e,(n,i,o,r)=>{const{drawCoordinates:a,drawOffset:{dx:s,dy:l}}=t;if(e.call(t,n+s,i+l,o,r),!a)return;const d={minX:n,minY:i,maxX:n+o,maxY:i+r};a.push({x:d.minX,y:d.minY},{x:d.maxX,y:d.maxY})}},y=t=>{const e=t.strokeRect;return t.$strokeRect=e,(n,i,o,r)=>{const{set:a}=s(),{drawCoordinates:l,drawOffset:{dx:d,dy:c}}=t;if(e.call(t,n+d,i+c,o,r),!l)return;const h={minX:n,minY:i,maxX:n+o,maxY:i+r},m=[{x:h.minX,y:h.minY},{x:h.maxX,y:h.maxY}];l.push(...m),a(t.lineWidth,m)}},w=t=>{const e=t.lineTo;return t.$lineTo=e,(n,i)=>{const{drawCoordinates:o,drawOffset:{dx:r,dy:a}}=t;if(e.call(t,n+r,i+a),!o)return;const{set:l}=s(),d={x:n,y:i};o.push(d),l(t.lineWidth,[d])}},b=t=>{const e=t.moveTo;return t.$moveTo=e,(n,i)=>{const{set:o}=s(),r={x:n,y:i},{drawCoordinates:a,drawOffset:{dx:l,dy:d}}=t;e.call(t,n+l,i+d),a&&(a.push(r),o(t.lineWidth,[r]))}},v=t=>{const e=t.bezierCurveTo;return t.$bezierCurveTo=e,(n,i,o,r,a,l)=>{const{set:d}=s(),{drawCoordinates:c,drawOffset:{dx:m,dy:u}}=t;if(e.call(t,n+m,i+u,o+m,r+u,a+m,l+u),!c)return;const x=c.at(-1);if(x){const{minX:e,minY:s,maxX:m,maxY:u}=h([{x:x.x,y:x.y},{x:a,y:l}],[{x:n,y:i},{x:o,y:r}],t),f=[{x:e,y:s},{x:m,y:u}];c.push(...f),d(t.lineWidth,f)}else{const e=[{x:n,y:i},{x:o,y:r},{x:a,y:l}];c.push(...e),d(t.lineWidth,e)}}},X=t=>{const e=t.quadraticCurveTo;return t.$quadraticCurveTo=e,(n,i,o,r)=>{const{set:a}=s(),{drawCoordinates:l,drawOffset:{dx:d,dy:c}}=t;if(e.call(t,n+d,i+c,o+d,r+c),!l)return;const m=l.at(-1);let u={x:n,y:i},x={x:o,y:r};if(m){const{minX:e,minY:a,maxX:s,maxY:l}=h([{x:o,y:r},{x:m.x,y:m.y}],[{x:n,y:i}],t);u={x:e,y:a},x={x:s,y:l}}const f=[u,x];l.push(...f),a(t.lineWidth,f)}},Y=t=>{const e=t.stroke;return t.$stroke=e,(...n)=>{const{drawCoordinates:i,drawOffset:{dx:o,dy:r}}=t;if(e.apply(t,n),!i)return;const{getAll:a,clear:l}=s(),d=t.lineWidth;if(1!==d){const t=a();for(const e of t){const t=e[1],n=Math.ceil((d-1)/2);for(const e of t)e.dWidth=n}}l()}};window.RAF=window.requestAnimationFrame||window.webkitRequestAnimationFrame||window.mozRequestAnimationFrame||window.oRequestAnimationFrame||window.msRequestAnimationFrame||function(t){window.setTimeout(t,1e3/60)};const M=()=>({arc:x,arcTo:f,rect:g,fillRect:p,strokeRect:y,moveTo:b,lineTo:w,bezierCurveTo:v,quadraticCurveTo:X,stroke:Y}),O=(t,e)=>{const{arc:n,arcTo:i,rect:o,fillRect:r,strokeRect:a,moveTo:s,lineTo:l,stroke:d}=M();t.arc=n(t),t.arcTo=i(t),t.rect=o(t),t.fillRect=r(t),t.strokeRect=a(t),t.moveTo=s(t),t.lineTo=l(t),t.quadraticCurveTo=X(t),t.bezierCurveTo=v(t),t.stroke=d(t)},T=t=>{var e,n,o,r;const a=i({minX:999999,maxX:-999999,minY:999999,maxY:-999999}),s=new Map;for(const e of t){const{x:t,y:n,dWidth:i}=e;a.minX>t&&(a.minX=t,s.set("minX",null!=i?i:0)),a.maxX<t&&(a.maxX=t,s.set("maxX",null!=i?i:0)),a.minY>n&&(a.minY=n,s.set("minY",null!=i?i:0)),a.maxY<n&&(a.maxY=n,s.set("maxY",null!=i?i:0))}const l={minX:a.minX-(null!==(e=s.get("minX"))&&void 0!==e?e:0),maxX:a.maxX+(null!==(n=s.get("maxX"))&&void 0!==n?n:0),minY:a.minY-(null!==(o=s.get("minY"))&&void 0!==o?o:0),maxY:a.maxY+(null!==(r=s.get("maxY"))&&void 0!==r?r:0)};return{ox:l.minX,oy:l.minY,width:l.maxX-l.minX,height:l.maxY-l.minY}},C=(t,e)=>{const{ox:n,oy:i,width:o,height:r}=e,a=n+o+4,s=i+r+4,l=new OffscreenCanvas(a,s).getContext("2d");t(l);const d=null==l?void 0:l.getImageData(0,0,a,s),c=null==d?void 0:d.data;let[h,m,u,x]=[n,i,n+o,i+r],f=!1;for(let t=m;t<s;t++){for(let e=h;e<a;e++){const n=4*(t*a+e),i=c[n],o=c[n+1],r=c[n+2],s=c[n+3];if(0!=i||0!=o||0!=r||0!=s){f=!0,m=t;break}}if(f)break}let g=!1;for(let t=i+r;t>i;t--){for(let e=n-4;e<a;e++){const n=4*(t*a+e),i=c[n],o=c[n+1],r=c[n+2],s=c[n+3];if(0!=i||0!=o||0!=r||0!=s){x=t,g=!0;break}}if(g)break}let p=!1;for(let t=n;t<a;t++){for(let e=i-4;e<s;e++){const n=4*(e*a+t),i=c[n],o=c[n+1],r=c[n+2],s=c[n+3];if(0!=i||0!=o||0!=r||0!=s){p=!0,h=t;break}}if(p)break}let y=!1;for(let t=n+o;t>t;t--){for(let e=i-4;e<s;e++){const n=4*(e*a+t),i=c[n],o=c[n+1],r=c[n+2],s=c[n+3];if(0!=i||0!=o||0!=r||0!=s){u=t,y=!0;break}}if(y)break}return{ox:h,oy:m,width:u-h,height:x-m}},S=new Map,$=t=>{const e=t+":";return{addModel:n=>{const i=(o=n,Array.isArray(o)?n:[n]);var o;const{width:a,height:s}=L.get(t).engine,l=((t,e)=>{const n=`${t}_${e}`;return r.get(n)||r.set(n,new OffscreenCanvas(t,e)).get(n)})(a,s),d=l.getContext("2d");O(d);for(const t of i){const{draw:n}=t;Object.defineProperty(t,"__draw__",{writable:!1,value:n}),t.draw=(()=>{let e=!1;return(i,o)=>{const r={dx:o&&t.graphics?o.x-t.graphics.ox:0,dy:o&&t.graphics?o.y-t.graphics.oy:0};if(i.drawOffset=r,e)n(i);else{const o=[];i.drawCoordinates=o,n(i);const r=C(n,T(o));t.graphics=Object.assign({},r),e=!0,i.drawCoordinates=null}}})(),S.set(`${e}${t.name}`,t),null==d||d.clearRect(0,0,a,s),t.draw(d)}},getModel:t=>S.get(`${e}${t}`),deleteModel:t=>S.delete(`${e}${t}`)}};class k{constructor(t,e,n,o,r){var a,s,d,c;this.index=0,this.data=void 0,this.borderOptions={needBorder:!0,paddingLeft:10,paddingRight:10,paddingTop:4,paddingBottom:4,borderDash:[5,5],borderWidth:1,borderColor:"teal",radius:0};const{getModel:h}=$(e);this.$model=h(t),this.borderOptions=Object.assign(Object.assign({},this.borderOptions),null!==(s=null===(a=this.$model)||void 0===a?void 0:a.borderOptions)&&void 0!==s?s:{}),this.id=`${e}:${l(8)}`,this.data=n,this.index=null!=r?r:this.index,this.belongEngineId=e,this._graphics=i(null===(d=this.$model)||void 0===d?void 0:d.graphics),this.graphics=i(null===(c=this.$model)||void 0===c?void 0:c.graphics),this.$model}draw(t,e={x:this.graphics.ox,y:this.graphics.oy}){var n,i;return this.ctx=null!=t?t:L.get(this.belongEngineId).engine.ctx,null===(i=null===(n=this.$model)||void 0===n?void 0:n.draw)||void 0===i||i.call(n,this.ctx,e),this.graphics=Object.assign(Object.assign({},this.graphics),{ox:e.x,oy:e.y}),this.drawBoundary(),this.id}drawBoundary(){const{paddingLeft:t,paddingRight:e,paddingTop:n,paddingBottom:i,borderDash:o,borderWidth:r,borderColor:a}=this.borderOptions,s=null!=a?a:"#993f55",l=null!=r?r:2,d=null!=o?o:[9,2],c=this.graphics.ox-(null!=t?t:4),h=this.graphics.oy-(null!=n?n:4),m=this.graphics.width+(null!=t?t:4)+(null!=e?e:4),u=this.graphics.height+(null!=n?n:4)+(null!=i?i:4),x=Math.ceil(l/2);this.boundary={minX:c-x,maxX:c+m+x,minY:h-x,maxY:h+u+x},this.ctx.save(),this.ctx.beginPath(),this.ctx.strokeStyle=s,this.ctx.lineWidth=l,this.ctx.setLineDash(d),this.ctx.$strokeRect(c,h,m,u),this.ctx.setLineDash([0,0]),this.ctx.restore()}isPointInTheShape(t){}clear(){const{ox:t,oy:e,width:n,height:i}=this.graphics,o=L.get(this.belongEngineId),r=o.engine.width,a=o.engine.height;console.log(n,i),L.get(this.belongEngineId).clearRect(0,0,r,a)}moveTo(t,e){const{repaintInfluencedShape:n}=L.get(this.belongEngineId).engine;this.clear(),n(this.graphics),this.clear(),n(this.graphics),this.draw(this.ctx,{x:t,y:e})}}const R=new Map;class j{constructor(t,e){this.addShape=t=>{this.shapes.push(t)},this.removeShape=t=>{this.shapes=this.shapes.filter((e=>e!==t))},this.id=l(6),this.boundary=t,this.isLeaf=e,!this.isLeaf&&(this.children=[])}}const _=new Map,I=t=>{const e=(t,n)=>{if(t.isLeaf)n.push(...t.shapes);else for(const i of t.children)e(i,n)},n=[];return e(t,n),[...new Set(n)]},P=Object.freeze({error:Symbol("__isError__"),engine:Symbol("__isEngine__"),shape:Symbol("__isShape"),model:Symbol("__isModel__")}),W=(t,e)=>{Object.defineProperty(t,P[e].description,{value:P[e],writable:!1})},A=t=>{const e=Object.create(null);return e.msg=t,W(e,"error"),e},L=new Map,B=t=>{const{id:e,width:r,height:a,canvas:s,modelList:d,readonly:c}=t,h=L.get(null!=e?e:"");if(h)return h;const m=s instanceof HTMLCanvasElement?s:"string"===(t=>Object.prototype.toString.call(t).slice(8,-1).toLowerCase())(s)&&document.querySelector(`#${s}`);if(!(m instanceof HTMLCanvasElement))throw A(`Create engine instance error: can't find a canvas dom by id ${s}`);const u=(y="2d",m.getContext(y,Object.assign(Object.assign({},{alpha:!0,antialias:!0,depth:!0,failIfMajorPerformanceCaveat:Boolean,powerPreference:"default",premultipliedAlpha:!1,preserveDrawingBuffer:!1,stencil:!0}),w))),x=null!=e?e:l(8),f=null!=c&&c,g=null!=r?r:300,p=null!=a?a:300;var y,w;O(u),n(m,g,p);const b=i({ctx:u,id:x,width:g,height:p,readonly:f,canvas:m}),{addModel:v,getModel:X,deleteModel:Y}=$(x),{drawShape:M,getShape:T,createShape:C}=((t,e)=>({createShape:(t,n,i,o)=>{const r=new k(t,e,n,i,o);return R.set(r.id,r),r},drawShape:(e,n)=>{try{const i=e.draw(t,n);return R.set(i,e),i}catch(t){console.warn("create Shape error: unknown error")}},getShape:t=>{if(!t){const t=[];for(const[n,i]of R.entries())n.split(":")[0]===e&&t.push(i);return t}return R.get(t)}}))(u,x),S=i({engine:b,addModel:t=>v(t),getModel:t=>X(t),deleteModel:t=>Y(t),drawShape:(t,e)=>{var n;try{return M(t,e)}catch(e){throw A(`Draw shape ${null===(n=t.$model)||void 0===n?void 0:n.name} course an error`)}},getShape:t=>T(t),clearRect:(t,e,n,i)=>{const{ctx:o}=b;o.clearRect(t,e,n,i)},createShape:(t,e)=>C(t,null==e?void 0:e.data,null==e?void 0:e.model,null==e?void 0:e.index),resizeCanvas:(t,e)=>{const{ctx:i,width:o,height:r,canvas:a}=b,s=i.getImageData(0,0,o,r);n(a,t,e),Object.assign(b,{width:t,height:e}),i.putImageData(s,0,0)}});W(S,"engine"),L.set(S.engine.id,S);const{getInfluencedShape:P}=(t=>{const e=(t=>{if(_.get(t))return _.get(t);const{engine:{width:e,height:n}}=L.get(t);!function t(e,n,i,o,r){const a=new j({minX:e,minY:n,maxX:e+i,maxY:n+o},3===r);if(r<4){const s=i/2,l=o/2;a.children.push(t(e,n,s,l,r+1)),a.children.push(t(e+s,n,s,l,r+1)),a.children.push(t(e,n+l,s,l,r+1)),a.children.push(t(e+s,n+l,s,l,r+1))}return a}(0,0,o(e,2),o(n,2),0)})(t);console.log("生成网格",e);const n={getInfluencedShape:t=>[].reduce(((t,e)=>[...t,...I(e)]),[])};return _.set(t,n),n})(x);return Object.defineProperty(b,"repaintInfluencedShape",{value:t=>{const e={minX:t.ox,minY:t.oy,maxX:t.ox+t.width,maxY:t.oy+t.height},n=P(e);for(const t of n)t.draw(u);console.log("受影响的shape",n)},writable:!1}),v(null!=d?d:[]),S};return e})()));